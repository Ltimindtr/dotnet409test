
name: Build & Push to Azure Container Registry (OIDC)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Repository name in ACR (e.g., hello-aspnet48 or myapp)"
        required: true
        default: hello-aspnet48
      dockerfile:
        description: "Path to Dockerfile"
        required: true
        default: Dockerfile
      context:
        description: "Docker build context"
        required: true
        default: .
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "**/*.csproj"
      - "**/*.sln"
      - "**/*.ps1"
      - "**/*.config"
      - "**/*.yml"
      - "**/*.yaml"
      - "src/**"
      - "app/**"

permissions:
  id-token: write
  contents: read

env:
  # Your ACR **resource name** (not the login server)
  # If the exact spelling is dotnet409scr, update this value.
  ACR_NAME: dotent409scr

  # When push triggers (not workflow_dispatch), use this default image repo name:
  DEFAULT_IMAGE_NAME: hello-aspnet48

  # Enable Docker Buildx on Linux runners for better caching (ignored on Windows)
  USE_BUILDX: "true"

jobs:
  build-and-push:
    # Pick one runner OS. Windows for Windows container images (e.g., ASP.NET 4.8),
    # Ubuntu for Linux images (e.g., WordPress, .NET 8).
    strategy:
      matrix:
        os: [windows-latest]
        # os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    concurrency:
      group: acr-publish-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine IMAGE_NAME and tags
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IMAGE_NAME="${{ github.event.inputs.image_name }}"
            DOCKERFILE="${{ github.event.inputs.dockerfile }}"
            CONTEXT="${{ github.event.inputs.context }}"
          else
            IMAGE_NAME="${DEFAULT_IMAGE_NAME}"
            DOCKERFILE="Dockerfile"
            CONTEXT="."
          fi
          SHA7="${GITHUB_SHA:0:7}"
          echo "image_name=${IMAGE_NAME}"  >> $GITHUB_OUTPUT
          echo "dockerfile=${DOCKERFILE}" >> $GITHUB_OUTPUT
          echo "context=${CONTEXT}"       >> $GITHUB_OUTPUT
          echo "sha_tag=${SHA7}"          >> $GITHUB_OUTPUT

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR login server (az acr show)
        id: acr
        shell: bash
        run: |
          LOGIN_SERVER=$(az acr show -n "${ACR_NAME}" --query loginServer -o tsv)
          if [[ -z "${LOGIN_SERVER}" ]]; then
            echo "Failed to resolve ACR login server for ${ACR_NAME}" >&2
            exit 1
          fi
          echo "login_server=${LOGIN_SERVER}" >> $GITHUB_OUTPUT
          echo "ACR login server: ${LOGIN_SERVER}"

      # --- DNS sanity checks ---
      - name: DNS check (Windows, PowerShell)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $fqdn = '${{ steps.acr.outputs.login_server }}'
          Write-Host "Testing DNS for $fqdn"
          Resolve-DnsName $fqdn -ErrorAction Stop | Format-Table | Out-String | Write-Host
          try {
            Resolve-DnsName $fqdn -Server 1.1.1.1 -ErrorAction Stop | Format-Table | Out-String | Write-Host
          } catch {
            Write-Warning "Public resolver check failed; continuing since default resolver worked."
          }

      - name: DNS check (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          FQDN="${{ steps.acr.outputs.login_server }}"
          echo "Testing DNS for ${FQDN}"
          getent ahosts "${FQDN}" || (echo "getent DNS failed" && exit 1)
          host "${FQDN}" || true
          nslookup "${FQDN}" || true
