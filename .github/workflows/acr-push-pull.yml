name: Build & Push Docker Image to ACR (Windows, Service Principal)

on:
  push:
    branches:
      - master  # This triggers the workflow only on changes to the master branch

jobs:
  build:
    runs-on: windows-latest  # Use Windows-based runner for Windows containers

    permissions:
      id-token: write      # REQUIRED for OIDC (if you're using OIDC login)
      contents: read

    env:
      AZURE_CLIENT_ID:        ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID:        ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID:  ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ACR_NAME:               ${{ secrets.AZURE_ACR_NAME }}
      IMAGE_NAME:             hello-aspnet48
      IMAGE_TAG_SHA:         ${{ github.sha }}
      IMAGE_LATEST:          latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # DNS check for ACR (optional)
      - name: DNS check for ACR (optional)
        shell: powershell
        run: |
          $fqdn = "$($env:ACR_NAME).azurecr.io"
          Write-Host "Testing DNS for $fqdn"
          try {
            Resolve-DnsName $fqdn -ErrorAction Stop | Format-Table
          } catch {
            Write-Warning "DNS resolution failed for $fqdn. If ACR uses Private Endpoint & private DNS, use a self-hosted runner in the VNet."
          }

      # Azure login using Service Principal for Windows runners (uses secrets for client-id and client-secret)
      - name: Azure login (Service Principal)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          client-secret:   ${{ secrets.AZURE_CLIENT_SECRET }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # ACR login using Azure CLI
      - name: ACR login (uses Service Principal)
        shell: powershell
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      # Build Docker image for Windows (only when changes are pushed to master)
      - name: Build Docker image (Windows)
        shell: powershell
        if: github.ref == 'refs/heads/master'  # Only runs when changes are pushed to master
        run: |
          $REG = "$($env:ACR_NAME)"
          $SHA7 = $env:IMAGE_TAG_SHA.Substring(0,7)
          $IMAGE_SHA = "$REG/$($env:IMAGE_NAME):$SHA7"
          $IMAGE_LATEST = "$REG/$($env:IMAGE_NAME):$($env:IMAGE_LATEST)"

          Write-Host "Building:"
          Write-Host "  $IMAGE_SHA"
          Write-Host "  $IMAGE_LATEST"

          docker build `
            -t $IMAGE_SHA `
            -t $IMAGE_LATEST `
            .

      # Push Docker image to ACR
      - name: Push image to ACR
        shell: powershell
        if: github.ref == 'refs/heads/master'  # Only runs when changes are pushed to master
        run: |
          $REG = "$($env:ACR_NAME).azurecr.io"
          $SHA7 = $env:IMAGE_TAG_SHA.Substring(0,7)
          $IMAGE_SHA = "$REG/$($env:IMAGE_NAME):$SHA7"
          $IMAGE_LATEST = "$REG/$($env:IMAGE_NAME):$($env:IMAGE_LATEST)"

          Write-Host "Pushing:"
          Write-Host "  $IMAGE_SHA"
          Write-Host "  $IMAGE_LATEST"

          docker push $IMAGE_SHA
